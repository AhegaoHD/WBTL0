# WB Tech: level # 0 (Golang)
**Конфигурация Docker Compose**

В файле `docker-compose.yml` содержатся следующие сервисы:
1. **postgres**: Этот сервис использует образ Docker `postgres:15.3`. Он настраивает контейнер базы данных PostgreSQL и связывает каталог `./volumes/pgdata` на хост-машине с папкой `/var/lib/postgresql/data` внутри контейнера. Данные базы данных будут храниться в указанном каталоге на хост-машине, обеспечивая сохранность данных. Сервис также использует файл окружения `.env` для загрузки переменных окружения, если он присутствует. Сервис доступен на порту `5555` на хост-машине, который отображается на порт `5432` внутри контейнера.
2. **nats**: Этот сервис использует образ Docker `nats-streaming:latest`. Он настраивает контейнер сервера NATS Streaming и открывает порты `4222` и `8222` на хост-машине, которые отображаются на соответствующие порты внутри контейнера.

Title: Главный файл приложения
Details: Этот файл представляет главный компонент приложения, который отвечает за отправку данных через NATS Streaming и взаимодействие с базой данных PostgreSQL.

**producer.go**

Внутри main() выполняются следующие шаги:

1. Устанавливается соединение с NATS Streaming сервером, работающим на адресе 127.0.0.1:4222.
2. Создается пример заказа (order) с использованием функции getExampleOrder().Эта функция используется для загрузки примера заказа из файла example.json. Она открывает файл, декодирует его содержимое в структуру pg.Order и возвращает эту структуру.
3. Определяется идентификатор заказа (id) на основе UID заказа.
4. Затем запускается бесконечный цикл, в котором заказу присваивается новый UID, и этот заказ отправляется через NATS с использованием сериализации в JSON. В консоли выводится информация о том, какой заказ был отправлен. После каждой отправки происходит пауза в 2 секунды.


**server.go**

Давайте рассмотрим основные компоненты этого серверного приложения:

Глобальные переменные: В файле определены несколько глобальных переменных, включая базу данных (db), кэш заказов (orderCache) и соединение NATS (nc).

Главная функция main(): В ней выполняются следующие шаги:

Инициализируются соединение с базой данных, кэш заказов и соединение NATS с помощью соответствующих функций initDB(), initCache(), и initNats().  
initDB(): Инициализирует соединение с базой данных PostgreSQL, используя параметры соединения из переменной connStr. Проверяет успешность соединения и обрабатывает ошибку, если она возникнет.  
initNats(): Инициализирует соединение с NATS Streaming сервером, работающим на адресе 127.0.0.1:4222.  
initCache(): Инициализирует кэш заказов и загружает данные из базы данных в этот кэш с помощью функции loadOrdersIntoCache().  
Происходит подписка на NATS-тему "subject". Когда приходит сообщение, оно десериализуется в структуру Order, отправляется в базу данных с помощью функции SendOrder() и сохраняется в кэше с помощью функции saveOrderToCache().  
Запускается HTTP-сервер, который обрабатывает запросы на /getOrder с помощью функции getOrderHandler().


Функция loadOrdersIntoCache(): Эта функция выполняет запрос к базе данных для получения всех заказов, их доставки, оплаты и товаров. Затем она наполняет кэш полученными данными.

Функции saveOrderToCache() и getOrderHandler(): saveOrderToCache() используется для сохранения заказа в кэше, а getOrderHandler() обрабатывает HTTP-запросы на /getOrder, извлекая заказ из кэша и возвращая его в формате JSON.

**pg/models.go**
Основные структы  
**pg/sql.go**  
SendOrder() - полсылает Order в транзакцией в бд